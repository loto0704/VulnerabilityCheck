# -*- coding:utf-8 -*-
import time, pandas, json, os, datetime
from selenium import webdriver
from selenium.webdriver.chrome import service
from selenium.webdriver.common.by import By

BASE_URL = "https://deps.dev/"
CONFIG_FILE = "config.json"


def main():
    json_data = path_get()
    file_name = f"{datetime.date.today()}_vulnerability_check.xlsx"
    if json_data["output_folder_path"] == "":
        output_folder_path = os.path.expanduser('~/Downloads')
    else:
        output_folder_path = json_data["output_folder_path"]
    export_full_path = f"{output_folder_path}/{file_name}"

    data_dict = txt_read()
    pd_data = scraping(data_dict, json_data["driver_path"])
    pd_data.to_excel(export_full_path, index=False, header=True)


def path_get():
    json_open = open(CONFIG_FILE, 'r')
    json_load = json.load(json_open)

    return json_load


# スクレイピング
def scraping(data_dict, driver_path):
    chrome_service = service.Service(executable_path=driver_path)
    driver = webdriver.Chrome(service=chrome_service)
    for i in range(len(data_dict)):
        library_name = data_dict[i]['library_name']
        library_ver = data_dict[i]['library_ver']

        url = f"{BASE_URL}pypi/{library_name}/{library_ver}"
        driver.get(url)
        time.sleep(2)

        try:
            security_advisories = driver.find_element(by=By.XPATH, value="/html/body/div/div[1]/div/div/div/div/div[1]/div[1]/div[1]/span").text
        except:
            try:
                time.sleep(2)
                # Version Not Found
                security_advisories = driver.find_element(by=By.XPATH, value="/html/body/div/div[1]/div/div/div/div/h1").text
            except:
                security_advisories = "error"

        data_dict[i]["security_advisories"] = security_advisories
        time.sleep(2)

    driver.close()

    data = pandas.DataFrame.from_dict(data_dict).T

    return data


# txtファイル読み込み
def txt_read():
    count = 0
    data_dict = {}
    with open('requirements.txt', mode='r', encoding='UTF-16') as f:
        for line in f.readlines():
            data_dict[count] = {}
            data_dict[count]["library_name"] = line.split('==')[0]
            data_dict[count]["library_ver"] = line.split('==')[1].replace("\n", "")
            count += 1

    return data_dict


if __name__ == '__main__':
    main()
